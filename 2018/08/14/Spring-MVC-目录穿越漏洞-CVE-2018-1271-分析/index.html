<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Java," />










<meta name="description" content="漏洞简介2018年04月05日，Pivotal公布了Spring MVC存在一个目录穿越漏洞(CVE-2018-1271)。Spring Framework版本5.0到5.0.4,4.3到4.3.14以及较旧的不受支持的版本允许应用程序配置Spring MVC以提供静态资源（例如CSS，JS，图像）。当Spring M">
<meta name="keywords" content="Java">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring MVC 目录穿越漏洞(CVE-2018-1271)分析">
<meta property="og:url" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/index.html">
<meta property="og:site_name" content="Badcode">
<meta property="og:description" content="漏洞简介2018年04月05日，Pivotal公布了Spring MVC存在一个目录穿越漏洞(CVE-2018-1271)。Spring Framework版本5.0到5.0.4,4.3到4.3.14以及较旧的不受支持的版本允许应用程序配置Spring MVC以提供静态资源（例如CSS，JS，图像）。当Spring MVC的静态资源存放在Windows系统上时，攻击可以通过构造特殊URL导致目录遍">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/version.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/result.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/handlerequest.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/getpath.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/invalid.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/cleanpath2.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/cleanPath.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/invalidpath1.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/invalidpath2.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/location.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/resolveresource.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/pathresourceresolver.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/pathgetresource1.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/pathgetresource2.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/getresource1.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/urlresource.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/resource.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/exists.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/file.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/getfile.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/specificpart.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/specificpart2.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/isreadable.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/write.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/write2.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/writecontent.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/getinputstream.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/encode.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/file2.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/result2.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/diff.png">
<meta property="og:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/invalidencodepath.png">
<meta property="og:updated_time" content="2018-08-31T04:48:55.298Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring MVC 目录穿越漏洞(CVE-2018-1271)分析">
<meta name="twitter:description" content="漏洞简介2018年04月05日，Pivotal公布了Spring MVC存在一个目录穿越漏洞(CVE-2018-1271)。Spring Framework版本5.0到5.0.4,4.3到4.3.14以及较旧的不受支持的版本允许应用程序配置Spring MVC以提供静态资源（例如CSS，JS，图像）。当Spring MVC的静态资源存放在Windows系统上时，攻击可以通过构造特殊URL导致目录遍">
<meta name="twitter:image" content="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/version.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/"/>





  <title>Spring MVC 目录穿越漏洞(CVE-2018-1271)分析 | Badcode</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Badcode</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://badgsd.github.io/2018/08/14/Spring-MVC-目录穿越漏洞-CVE-2018-1271-分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Badcode">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Badcode">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Spring MVC 目录穿越漏洞(CVE-2018-1271)分析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-14T12:37:17+08:00">
                2018-08-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h3><p>2018年04月05日，Pivotal公布了Spring MVC存在一个目录穿越漏洞(CVE-2018-1271)。Spring Framework版本5.0到5.0.4,4.3到4.3.14以及较旧的不受支持的版本允许应用程序配置Spring MVC以提供静态资源（例如CSS，JS，图像）。当Spring MVC的静态资源存放在Windows系统上时，攻击可以通过构造特殊URL导致目录遍历漏洞。</p>
<h3 id="漏洞影响"><a href="#漏洞影响" class="headerlink" title="漏洞影响"></a>漏洞影响</h3><ul>
<li>Spring Framework 5.0 to 5.0.4.</li>
<li>Spring Framework 4.3 to 4.3.14</li>
<li>已不支持的旧版本仍然受影响</li>
</ul>
<h3 id="漏洞利用条件"><a href="#漏洞利用条件" class="headerlink" title="漏洞利用条件"></a>漏洞利用条件</h3><ul>
<li>Server运行于Windows系统上</li>
<li>要使用file协议打开资源文件目录</li>
</ul>
<h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><h4 id="复现环境"><a href="#复现环境" class="headerlink" title="复现环境"></a>复现环境</h4><ul>
<li>操作系统Windows</li>
</ul>
<ul>
<li>web代码 <a href="https://github.com/spring-projects/spring-mvc-showcase" target="_blank" rel="noopener">spring-mvc-showcase</a></li>
</ul>
<ul>
<li>中间件jetty</li>
</ul>
<h4 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h4><ol>
<li><p>下载 spring-mvc-showcase</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/spring-projects/spring-mvc-showcase.git</span><br></pre></td></tr></table></figure>
<p>修改<code>pom.xml</code>，使用Spring Framework 5.0.0。</p>
<p><img src="version.png" alt=""></p>
</li>
<li><p>修改 Spring MVC  静态资源配置，可参考<a href="https://docs.spring.io/spring-framework/docs/5.0.4.RELEASE/spring-framework-reference/web.html#mvc-config-static-resources" target="_blank" rel="noopener">官方文档</a></p>
<p>通过官方文档可知有两种方式配置，可自行选择配置。此处通过重写<code>WebMvcConfigurer</code>中的<code>addResourceHandlers</code>方法来添加新的资源文件路径。在<code>org.springframework.samples.mvc.config.WebMvcConfig</code>添加以下代码即可，使用<code>file://</code>协议指定<code>resources</code>为静态文件目录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">registry.addResourceHandler(&quot;/resources/**&quot;).addResourceLocations(&quot;file:./src/main/resources/&quot;,&quot;/resources/&quot;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 jetty 启动项目</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn jetty:run</span><br></pre></td></tr></table></figure>
<p>至此复现环境搭建完毕。</p>
</li>
</ol>
<h4 id="复现过程及结果"><a href="#复现过程及结果" class="headerlink" title="复现过程及结果"></a>复现过程及结果</h4><p>访问以下链接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8080/spring-mvc-showcase/resources/%255c%255c..%255c/..%255c/..%255c/..%255c/..%255c/..%255c/..%255c/..%255c/..%255c/windows/win.ini</span><br></pre></td></tr></table></figure>
<p><img src="result.png" alt=""></p>
<p>可以看到成功读取到<code>win.ini</code>的内容了。</p>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>当外部要访问静态资源时，会调用<code>org.springframework.web.servlet.resource.ResourceHttpRequestHandler:handleRequest</code>来处理，在这里下断点调试。</p>
<p><img src="handlerequest.png" alt=""></p>
<p>跟进<code>org.springframework.web.servlet.resource.ResourceHttpRequestHandler:getResource()</code>。</p>
<p><img src="getpath.png" alt=""></p>
<p>在<code>request</code>中保存的路径是<code>/spring-mvc-showcase/resources/%255c%255c..%255c/..%255c/..%255c/..%255c/..%255c/..%255c/..%255c/..%255c/..%255c/windows/win.ini</code>。在<code>request.getAttribute()</code>函数取值时会进行 url decode操作，此时<code>path</code>的值为<code>%5c%5c..%5c/..%5c/..%5c/..%5c/..%5c/..%5c/..%5c/..%5c/..%5c/windows/win.ini</code>。接下来会对path进行两次校验，将<code>path</code>和<code>path</code>解码之后的值分别使用<code>isInvalidPath</code>函数检查。看下这个函数</p>
<p><img src="invalid.png" alt=""></p>
<p>当<code>path</code>包含有<code>..</code>的时候，会调用<code>cleanPath</code>函数对<code>path</code>处理。跟进</p>
<p><img src="cleanpath2.png" alt=""> </p>
<p>这个函数的作用是把包含<code>..</code>的这种相对路径转换成绝对路径。例如<code>/foo/bar/../</code>经过<code>cleanPath</code>处理后就会变成<code>/foo/</code>。</p>
<p><code>cleanPath</code>的问题在于<code>String[] pathArray = delimitedListToStringArray(pathToUse, &quot;/&quot;);</code>这个是允许空元素存在的，也就是说<code>cleanPath</code>会把<code>//</code>当成一个目录，而操作系统是不会把<code>//</code>当成一个目录的。借用一张Orange大佬的图。</p>
<p><img src="cleanPath.png" alt=""></p>
<p>继续回到流程上，上面说到会对path进行两次校验，第一次调用<code>isInvalidPath</code>，<code>path</code>的值是<code>%5c%5c..%5c/..%5c/..%5c/..%5c/..%5c/..%5c/..%5c/..%5c/..%5c/windows/win.ini</code>，因为<code>path</code>以<code>/</code>分割之后没有元素等于<code>..</code>，所以<code>path</code>经过<code>cleanPath</code>处理后的值不变，继续之后的判断，<code>path</code>里面也不包含<code>../</code>，所以最终返回<code>false</code>，也就是通过了校验。</p>
<p><img src="invalidpath1.png" alt=""></p>
<p>第二次调用<code>isInvalidPath(URLDecoder.decode(path, &quot;UTF-8&quot;))</code>，此时参数值是<code>\\..\/..\/..\/..\/..\/..\/..\/..\/..\/windows/win.ini</code>，经过<code>cleanPath</code>处理后的值是<code>//windows/win.ini</code>，之后继续判断，<code>path</code>里面也不包含<code>../</code>，最终返回false，也通过了校验。</p>
<p><img src="invalidpath2.png" alt=""></p>
<p>通过两次校验之后，继续向下执行。获取一个<code>Resource</code>对象</p>
<p><img src="location.png" alt=""></p>
<p><code>path</code>的值还是之前，<code>getLocations()</code>获取到的就是之前在配置文件中配置的路径<code>file:./src/main/resources/</code>，继续跟进</p>
<p><img src="resolveresource.png" alt=""></p>
<p>跟进<code>ResourceResolver</code>类的<code>resolveResource</code></p>
<p><img src="pathresourceresolver.png" alt=""></p>
<p>跟进<code>PathResourceResolver</code>的<code>resolveResourceInternal</code></p>
<p><img src="pathgetresource1.png" alt=""></p>
<p>进入到<code>org.springframework.web.servlet.resource.PathResourceResolver</code>的<code>getResource()</code></p>
<p><img src="pathgetresource2.png" alt=""></p>
<p>此时的<code>resourcePath</code>就是之前的<code>path</code>，<code>location</code>就是之前<code>getLocations()</code>获取到的值。继续跟进<code>this.getResource</code></p>
<p><img src="getresource1.png" alt=""></p>
<p>调用<code>location.createRelativ</code>拼接得到文件的绝对路径，返回一个<code>UrlResource</code>对象</p>
<p><img src="urlresource.png" alt=""></p>
<p>返回到到<code>getResource</code>函数</p>
<p><img src="resource.png" alt=""></p>
<p>此时，<code>resource</code>是一个<code>UrlResource</code>对象，可以看到值是<code>file:src/main/resources/%5c%5c..%5c/..%5c/..%5c/..%5c/..%5c/..%5c/..%5c/..%5c/..%5c/windows/win.ini</code>，之后调用<code>exists()</code>方法检查该文件是否存在，调用<code>isReadable()</code>方法检测该文件是否可读。进去<code>exists()</code>方法</p>
<p><img src="exists.png" alt=""></p>
<p>这里会调用<code>isFileURL</code>对<code>url</code>进行判断，是否以<code>file://</code>协议来读取文件，这也是为什么配置静态目录的时候要使用<code>file://</code>协议。</p>
<p><img src="file.png" alt=""></p>
<p>通过判断之后，会调用<code>this.getFile()</code>来获取这个文件对象，这个方法在<code>org.springframework.util.ResourceUtils</code>这个方法类里面，跟进</p>
<p><img src="getfile.png" alt=""></p>
<p>这里对是否为<code>file://</code>协议又判断了一次，之后进行了一步最重要的操作<code>new File(toURI(resourceUrl).getSchemeSpecificPart());</code>，将<code>resourceUrl</code>转换为URL对象，最后调用<code>URI</code>类的<code>getSchemeSpecificPart()</code>获取到文件路径，而在<code>getSchemeSpecificPart()</code>里面是有一次<code>decode</code>操作的，也就是在这里把<code>%5c</code>解码成了<code>\</code>，跟进</p>
<p><img src="specificpart.png" alt=""></p>
<p><img src="specificpart2.png" alt=""></p>
<p>最后返回到<code>exists()</code>，最终返回<code>true</code>，即文件存在</p>
<p>之后调用<code>isReadable()</code>方法检测该文件是否可读的时候，同样会调用这个<code>getFile</code>，最终返回<code>true</code>，即文件可读。</p>
<p><img src="isreadable.png" alt=""></p>
<p>至此，对于<code>resource</code>的判断都结束了。返回到<code>org.springframework.web.servlet.resource.ResourceHttpRequestHandler:handleRequest()</code>，获取到通过校验<code>resource</code>的之后，就开始准备response的内容了，包含获取文件的类型(用于response的Content-type)，文件的大小(用于response的Content-length)等等，最后调用<code>this.resourceHttpMessageConverter.write(resource, mediaType, outputMessage);</code>获取文件的内容并返回给用户。</p>
<p><img src="write.png" alt=""></p>
<p>跟进<code>write()</code></p>
<p><img src="write2.png" alt=""></p>
<p>跟进<code>writeInternal</code>，之后再跳到<code>writeContent</code></p>
<p><img src="writecontent.png" alt=""></p>
<p>跟进<code>resource.getInputSream()</code></p>
<p><img src="getinputstream.png" alt=""></p>
<p>可以看到，这里使用<code>openConnection</code>创建一个<code>URLConnection</code>实例，也是在<code>openConnection</code>方法内，会自动<code>decode</code>，把<code>%5c</code>解码成<code>\</code>，然后返回文件的<code>InputStream</code>对象，最终读取内容返回给用户。</p>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol>
<li><p>这个漏洞是可以在 Tomcat 下触发的，因为payload的双URL编码的。</p>
</li>
<li><p>在Spring Framework 大于5.0.1的版本(我的测试环境5.0.4)，双URL编码payload是不行的，单次URL编码的payload的却是可以的，这种情况下该漏洞就无法在Tomcat下触发了，因为在默认情况下Tomcat遇到包含%2f(/) %5c(\)的URL直接http 400，在 jetty 下是可以触发的。</p>
<p>至于为什么双URL编码不行，是因为<code>org.springframework.web.servlet.resource.PathResourceResolver</code>的<code>getResource()</code>多了一个<code>encode</code>操作。</p>
<p><img src="encode.png" alt=""></p>
<p>如果是双URL编码payload的进来，在获取<code>path</code>的时候解码一次，经过一次<code>isInvalidPath</code>判断，然后进入到<code>PathResourceResolver</code>的<code>getResource()</code>，也就是上图的位置，这里又会重新编码一次，又回到了双编码的情况了。最后在文件判断是否存在<code>exists()</code>方法的时候，<code>getSchemeSpecificPart()</code>只能解码一次，之后是无法读取到文件的，也就是文件不存在。</p>
<p><img src="file2.png" alt=""></p>
<p>所以这里要使用单次编码才行。</p>
<p><img src="result2.png" alt=""></p>
</li>
</ol>
<h3 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h3><p>看官方的<a href="https://github.com/spring-projects/spring-framework/commit/0e28bee0f155b9bf240b4bafc4646e4810cb23f8#diff-ca3a08ce8b5af11bfc5f03aa7f426cd9" target="_blank" rel="noopener">补丁</a>，是在<code>ResourceHttpRequestHandler</code>的<code>getResource()</code>里面把<code>processPath</code>重写了</p>
<p><img src="diff.png" alt=""></p>
<p>在进入<code>isInvalidPath</code>之前调用<code>processPath</code>函数对<code>path</code>处理，替换反斜线为斜线，删掉多余斜线，从而导致在<code>isInvalidPath</code>里面校验不通过。如果使用双编码方式的话，会经过<code>isInvalidEncodedPath</code>，里面会先对<code>path</code>解码，然后调用<code>processPath</code>处理，最后经过<code>isInvalidPath</code>，同样无法通过检查。</p>
<p><img src="invalidencodepath.png" alt=""></p>
<h3 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h3><ul>
<li>Spring Framework 5.*（5.0到5.0.4）版本，建议更新到5.0.5版本</li>
<li>Spring Framework 4.3.*（4.3到4.3.14）版本，建议更新到4.3.15版本</li>
<li>不再受支持的旧版本，建议更新到4.3.15版本或5.0.5版本</li>
</ul>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul>
<li><a href="https://pivotal.io/security/cve-2018-1271" target="_blank" rel="noopener">CVE-2018-1271: Directory Traversal with Spring MVC on Windows</a></li>
<li><a href="http://i.blackhat.com/us-18/Wed-August-8/us-18-Orange-Tsai-Breaking-Parser-Logic-Take-Your-Path-Normalization-Off-And-Pop-0days-Out-2.pdf" target="_blank" rel="noopener">Breaking Parser Logic! Take Your Path Normalization Off and Pop 0days Out</a></li>
<li><a href="https://bl4ck.in/vulnerability/analysis/2018/04/10/Directory-Traversal-with-Spring-MVC-on-Window.html" target="_blank" rel="noopener">Directory Traversal with Spring MVC on Windows</a></li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Java/" rel="tag"># Java</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/05/26/NagiosXI-5-4-12-多个SQL注入漏洞/" rel="next" title="NagiosXI <= 5.4.12 多个SQL注入漏洞">
                <i class="fa fa-chevron-left"></i> NagiosXI <= 5.4.12 多个SQL注入漏洞
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/08/20/MetInfo-任意文件读取漏洞的修复与绕过/" rel="prev" title="MetInfo 任意文件读取漏洞的修复与绕过">
                MetInfo 任意文件读取漏洞的修复与绕过 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Badcode</p>
              <p class="site-description motion-element" itemprop="description">学习经历</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞简介"><span class="nav-number">1.</span> <span class="nav-text">漏洞简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞影响"><span class="nav-number">2.</span> <span class="nav-text">漏洞影响</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞利用条件"><span class="nav-number">3.</span> <span class="nav-text">漏洞利用条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞复现"><span class="nav-number">4.</span> <span class="nav-text">漏洞复现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#复现环境"><span class="nav-number">4.1.</span> <span class="nav-text">复现环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#环境搭建"><span class="nav-number">4.2.</span> <span class="nav-text">环境搭建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#复现过程及结果"><span class="nav-number">4.3.</span> <span class="nav-text">复现过程及结果</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞分析"><span class="nav-number">5.</span> <span class="nav-text">漏洞分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#注意事项"><span class="nav-number">6.</span> <span class="nav-text">注意事项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#补丁分析"><span class="nav-number">7.</span> <span class="nav-text">补丁分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞修复"><span class="nav-number">8.</span> <span class="nav-text">漏洞修复</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考链接"><span class="nav-number">9.</span> <span class="nav-text">参考链接</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Badcode</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
